<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WhatsApp Embedded Signup</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #status { margin-top: 1rem; color: #555; }
  </style>

  <div id="fb-root"></div>

  <script>
    // Optional: force same window open
    window.open = function(url) {
      console.log('[embed] Redirecting to:', url);
      window.location.href = url;
    };

    function logStatus(msg) {
      console.log('[embed] STATUS:', msg);
      document.getElementById('status').textContent = msg;
    }

    function onFbSdkError() {
      console.error('[embed] FB SDK failed to load');
      logStatus('FB SDK failed');
    }

    function redirectWithData(payload) {
      const data = payload.data || {};
      const params = new URLSearchParams();

      if (data.waba_id) params.append('waba_id', data.waba_id);
      if (data.phone_number_id) params.append('phone_number_id', data.phone_number_id);
      if (payload.code || data.code) params.append('code', payload.code || data.code);
      if (data.business_id) params.append('business_id', data.business_id);

      const redirectURL = "https://mukulkumar8285.github.io/whatsapp-callback.html?" + params.toString();
      console.log('[embed] Redirecting with data to:', redirectURL);
      window.location.href = redirectURL;
    }

    window.addEventListener('message', (event) => {
      try {
        const payload = JSON.parse(event.data);
        if (payload.type === 'WA_EMBEDDED_SIGNUP') {
          logStatus('Signup completed. Redirecting...');
          redirectWithData(payload);
        }
      } catch (err) {
        console.error('[embed] Invalid message:', err);
      }
    });

    function initFB() {
      FB.init({
        appId: '523707793850383',
        autoLogAppEvents: true,
        xfbml: false,
        version: 'v23.0',
      });
      logStatus('FB SDK initialized. Launching signup…');
      launchWhatsAppSignup();
    }

    function launchWhatsAppSignup() {
      FB.login((response) => {
        if (response.status === 'connected') {
          logStatus('FB login success. Waiting for signup…');
        } else {
          logStatus('FB login failed or canceled.');
        }
      }, {
        config_id: '683389464136204',
        response_type: 'code',
        override_default_response_type: true,
        redirect_uri: "https://mukulkumar8285.github.io/whatsapp-callback.html",
        extras: {
          setup: {},
          sessionInfoVersion: '3'
        }
      });
    }
  </script>

  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"
    onload="initFB()"
    onerror="onFbSdkError()">
  </script>
</head>
<body>
  <h2>WhatsApp Embedded Signup</h2>
  <div id="status">Loading…</div>
</body>
</html>
