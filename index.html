<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp Embedded Signup</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #status { margin-top: 1rem; color: #555; }
  </style>
</head>
<body>
  <!-- Optional status display -->
  <div id="status">Initializing...</div>
  <div id="fb-root"></div>

  <script>
    // Constants
    const APP_ID    = '523707793850383';
    const CONFIG_ID = '683389464136204';

    // Helper to log status on screen and console
    function logStatus(msg) {
      console.log('[embed] STATUS:', msg);
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }

    // Post message to React Native
    function postToRN(payload) {
      const msg = JSON.stringify(payload);
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(msg);
        console.log('[embed] postMessage â†’', payload);
      }
    }

    // Handle FB SDK load error
    function onFbSdkError() {
      logStatus('FB SDK failed to load');
      postToRN({ success: false, error: 'sdk_load_failure' });
    }

    // Parse legacy fragment #cb={...}
    function parseCbFragment() {
      const hash = window.location.hash || '';
      if (!hash.startsWith('#cb=')) return null;
      try {
        return JSON.parse(decodeURIComponent(hash.slice(4)));
      } catch {}
      return null;
    }

    // Launch the embedded signup flow
    function launchWhatsAppSignup() {
      logStatus('Launching WhatsApp signup...');

      FB.login(response => {
        // User canceled or failed
        if (response.status !== 'connected') {
          logStatus('User cancelled or not authorized');
          postToRN({ success: false, error: 'user_cancel', details: response });
        }
        // Otherwise, wait for postMessage or fragment
      }, {
        config_id: CONFIG_ID,
        response_type: 'code',
        override_default_response_type: true,
        redirect_uri: window.location.href,
        extras: { setup: {}, version: 'v3' }
      });
    }

    // Listen for postMessage JSON payload
    window.addEventListener('message', event => {
      if (typeof event.data !== 'string') return;
      try {
        const payload = JSON.parse(event.data);
        if (payload.type === 'WA_EMBEDDED_SIGNUP') {
          logStatus('Signup completed');
          postToRN({ success: true, data: payload });
          return;
        }
      } catch {};
    });

    // Initialize FB SDK on load
    window.fbAsyncInit = function() {
      logStatus('FB SDK ready, initializing...');
      FB.init({
        appId:            APP_ID,
        autoLogAppEvents: true,
        xfbml:            false,
        version:          'v23.0'
      });

      // Check legacy fragment first
      const cbData = parseCbFragment();
      if (cbData) {
        logStatus('Received fragment payload');
        postToRN({ success: true, data: cbData });
      } else {
        launchWhatsAppSignup();
      }
    };

    // Inject SDK script
    (function(d, s, id) {
      const fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      const js = d.createElement(s);
      js.id = id;
      js.async = true;
      js.defer = true;
      js.onerror = onFbSdkError;
      js.src = 'https://connect.facebook.net/en_US/sdk.js';
      fjs.parentNode.insertBefore(js, fjs);
    })(document, 'script', 'facebook-jssdk');
  </script>
</body>
</html>