<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WhatsApp Embedded Signup</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #status { margin-top: 1rem; color: #555; }
  </style>
  <div id="fb-root"></div>

  <script>
    const APP_ID = '523707793850383';
    const CONFIG_ID = '683389464136204';
    const REDIRECT_URI = 'https://mukulkumar8285.github.io/whatsapp-callback.html';

    function logStatus(msg) {
      console.log('[embed.html] STATUS:', msg);
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }

    function postToRN(obj) {
      const str = JSON.stringify(obj);
      console.log('[embed.html] postToRN data:', obj);
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(str);
        console.log('[embed.html] postMessage sent to RN');
      }
    }

    function closeWindowAfterDelay(seconds) {
      logStatus(`Signup successful. Closing in ${seconds} seconds...`);
      setTimeout(() => {
        logStatus("Closing window now.");
        window.close(); // this works only if window was opened via JS
        window.location.href = "https://www.facebook.com/dialog/close_window/?app_id=" + APP_ID;
      }, seconds * 1000);
    }

    function onFbSdkError() {
      logStatus('FB SDK load error');
      postToRN({ success: false, error: 'FB SDK load error' });
    }

    function launchWhatsAppSignup() {
      logStatus('Launching Embedded Signup...');
      FB.login(response => {
        console.log('FB.login response:', response);
        if (response.status === 'connected') {
          logStatus('Login succeeded. Waiting for embedded signup...');
        } else {
          logStatus('Login failed or cancelled.');
          postToRN({ success: false, error: 'Login failed' });
        }
      }, {
        config_id: CONFIG_ID,
        response_type: 'code',
        override_default_response_type: true,
        redirect_uri: REDIRECT_URI,
        extras: {
          setup: {},
          sessionInfoVersion: '3'
        }
      });
    }

    window.addEventListener("message", (event) => {
      console.log('[embed.html] message event received:', event.origin, event.data);
      let payload;
      try {
        payload = JSON.parse(event.data);
        if (payload.type === 'WA_EMBEDDED_SIGNUP') {
          logStatus('Signup completed.');
          postToRN({ success: true, data: payload });
          closeWindowAfterDelay(15);
        } else {
          console.warn('Unknown message type:', payload.type);
        }
      } catch (e) {
        console.error('Failed to parse message:', e);
      }
    });

    function initFB() {
      logStatus('Initializing FB SDK...');
      FB.init({
        appId: APP_ID,
        version: 'v23.0',
        xfbml: false
      });
      launchWhatsAppSignup();
    }
  </script>

  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"
    onload="initFB()"
    onerror="onFbSdkError()">
  </script>
</head>

<body>
  <h2>WhatsApp Embedded Signup</h2>
  <div id="status">Loading...</div>
</body>
</html>
