<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WhatsApp Embedded Signup</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #status { margin-top: 1rem; color: #555; }
  </style>

  <!-- Prepare container for FB SDK -->
  <div id="fb-root"></div>

  <!-- Override window.open to force same-window navigation -->
  <script>
    console.log('[embed.html] Override window.open');
    window.open = function(url) {
      console.log('[embed.html] window.open called, navigating to:', url);
      window.location.href = url;
    };
  </script>

  <!-- Helper functions -->
  <script>
    function logStatus(msg) {
      console.log('[embed.html] STATUS:', msg);
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }
    function postToRN(obj) {
      const str = JSON.stringify(obj);
      console.log('[embed.html] postToRN data:', obj);
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(str);
        console.log('[embed.html] postMessage sent to RN');
      }
    }
    function onFbSdkError() {
      console.error('[embed.html] ERROR loading FB SDK');
      logStatus('ERROR loading FB SDK');
      postToRN({ success: false, error: 'FB SDK failed to load' });
      redirectWithError('sdk_error');
    }
    function redirectWithError(errorCode) {
      console.warn('[embed.html] redirectWithError:', errorCode);
      const redirectBase = 'https://mukulkumar8285.github.io/facebooksdk/';
      const url = redirectBase + '?error=' + encodeURIComponent(errorCode);
      console.log('[embed.html] redirecting to:', url);
      window.location.href = url;
    }
    function redirectWithData(payload) {
      console.log('[embed.html] redirectWithData payload:', payload);
      const redirectBase = 'https://mukulkumar8285.github.io/facebooksdk/';
      const params = [];
      if (payload.data && payload.data.waba_id) params.push('waba_id=' + encodeURIComponent(payload.data.waba_id));
      if (payload.data && payload.data.phone_number_id) params.push('phone_number_id=' + encodeURIComponent(payload.data.phone_number_id));
      if (payload.data && payload.data.code) params.push('code=' + encodeURIComponent(payload.data.code));
      const url = redirectBase + (params.length ? ('?' + params.join('&')) : '');
      console.log('[embed.html] redirecting with data to:', url);
      window.location.href = url;
    }
  </script>

  <!-- Load FB JavaScript SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"
    onload="initFB()"
    onerror="onFbSdkError()">
  </script>

  <script>
    const APP_ID    = '523707793850383';
    const CONFIG_ID = '683389464136204';

    function initFB() {
      console.log('[embed.html] initFB called');
      logStatus('Initializing FB SDK…');
      FB.init({
        appId            : APP_ID,
        autoLogAppEvents : true,
        xfbml            : false,
        version          : 'v23.0'
      });
      console.log('[embed.html] FB.init complete');
      logStatus('FB SDK initialized. Launching Embedded Signup...');
      launchWhatsAppSignup();
    }

    window.addEventListener('message', event => {
      console.log('[embed.html] message event received from origin:', event.origin);
      let payload;
      try {
        payload = JSON.parse(event.data);
        console.log('[embed.html] parsed payload:', payload);
      } catch (err) {
        console.error('[embed.html] JSON.parse error:', err, 'data:', event.data);
        return;
      }
      if (payload.type === 'WA_EMBEDDED_SIGNUP') {
        logStatus('Signup completed. Sending to React Native…');
        postToRN({ success: true, data: payload });
        redirectWithData(payload);
      } else {
        console.warn('[embed.html] Ignoring payload.type:', payload.type);
      }
    });

    function launchWhatsAppSignup() {
      console.log('[embed.html] launchWhatsAppSignup called');
      FB.login(response => {
        console.log('[embed.html] FB.login response:', response);
        if (response.status === 'connected') {
          logStatus('Login succeeded, awaiting embedded signup…');
        } else {
          console.error('[embed.html] User canceled or login failed', response);
          logStatus('User canceled or login failed');
          postToRN({ success: false, error: response });
          redirectWithError('user_canceled');
        }
      }, {
        config_id: CONFIG_ID,
        response_type: 'code',
        override_default_response_type: true,
        extras: {
          setup: {},
          featureType: '',
          sessionInfoVersion: '3'
        }
      });
    }
  </script>
</head>

<body>
  <h2>WhatsApp Embedded Signup</h2>
  <div id="status">Initializing…</div>
</body>
</html>
