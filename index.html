<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp Embedded Signup</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    #status {
      margin-top: 1rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>WhatsApp Embedded Signup</h2>
  <div id="status">Initializing...</div>
  <div id="fb-root"></div>

  <script>
    // Constants
    const APP_ID = '523707793850383';
    const CONFIG_ID = '683389464136204';
    const REDIRECT_URI = 'https://mukulkumar8285.github.io/facebooksdk/whatsapp-callback';

    // Replace window.open to force same-window redirect
    console.log('[embed.html] Overriding window.open');
    window.open = function (url) {
      console.log('[embed.html] window.open intercepted, redirecting to:', url);
      window.location.href = url;
    };

    // Helper to log status on screen and console
    function logStatus(msg) {
      console.log('[embed.html] STATUS:', msg);
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }

    // Post message to React Native (if present)
    function postToRN(data) {
      try {
        const str = JSON.stringify(data);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(str);
          console.log('[embed.html] postMessage sent to React Native:', data);
        }
      } catch (e) {
        console.error('[embed.html] Failed to stringify data for RN:', e);
      }
    }

    // Redirect or close the window after a delay
    function closeAfterSuccess(seconds = 15) {
      logStatus(`Signup completed. Closing window in ${seconds} seconds...`);
      setTimeout(() => {
        try {
          window.close();
        } catch (err) {
          console.warn('[embed.html] window.close failed. Redirecting instead.');
        }
        window.location.href = 'https://mukulkumar8285.github.io/facebooksdk/whatsapp-callback';
      }, seconds * 1000);
    }

    // Handle SDK load failure
    function onFbSdkError() {
      console.error('[embed.html] FB SDK failed to load');
      logStatus('FB SDK failed to load');
      postToRN({ success: false, error: 'sdk_load_failure' });
    }

    // Initialize FB SDK
    function initFB() {
      console.log('[embed.html] Initializing FB SDK');
      logStatus('FB SDK loaded. Launching WhatsApp Signup...');

      // Directly launch signup to avoid popup
      launchWhatsAppSignup();
    }

    // Launch WhatsApp embedded signup without popup
    function launchWhatsAppSignup() {
      console.log('[embed.html] launchWhatsAppSignup started (no popup)');
      const signupUrl = `https://www.facebook.com/v23.0/dialog/oauth?client_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=whatsapp_business_messaging,whatsapp_business_management,business_management&response_type=code&config_id=${CONFIG_ID}`;
      logStatus('Redirecting to embedded signup in same windowâ€¦');
      window.location.href = signupUrl;
    }

    // Handle messages from Facebook (e.g., embedded flow completion)
    window.addEventListener('message', (event) => {
      console.log('[embed.html] Message received from origin:', event.origin);

      if (typeof event.data !== 'string') {
        console.warn('[embed.html] Ignoring non-string message:', event.data);
        return;
      }

      try {
        const payload = JSON.parse(event.data);
        console.log('[embed.html] Parsed payload:', payload);

        if (payload.type === 'WA_EMBEDDED_SIGNUP') {
          logStatus('Signup completed successfully!');
          postToRN({ success: true, data: payload });
          closeAfterSuccess(15);
        } else {
          console.warn('[embed.html] Unknown payload type:', payload.type);
        }
      } catch (err) {
        console.error('[embed.html] Failed to parse message:', err, event.data);
      }
    });
  </script>

  <!-- Load FB SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"
    onload="initFB()"
    onerror="onFbSdkError()">
  </script>
</body>
</html>
