<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WhatsApp Embedded Signup</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #status { margin-top: 1rem; color: #555; }
  </style>

  <!-- 1) Prepare container for FB SDK -->
  <div id="fb-root"></div>

  <!-- 2) Override window.open to force same-window navigation -->
  <script>
    window.open = function(url) {
      window.location.href = url;
    };
  </script>

  <!-- 3) Helper functions -->
  <script>
    function logStatus(msg) {
      console.log('[embed.html]', msg);
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }
    function postToRN(obj) {
      const str = JSON.stringify(obj);
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(str);
      } else {
        console.log('[embed.html] no RN bridge, data:', obj);
      }
    }
    function onFbSdkError() {
      logStatus('ERROR loading FB SDK');
      postToRN({ success: false, error: 'FB SDK failed to load' });
    }
  </script>

  <!-- 4) Load FB JavaScript SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"
    onload="initFB()"
    onerror="onFbSdkError()">
  </script>

  <script>
    const APP_ID    = '523707793850383';
    const CONFIG_ID = '683389464136204'; // Embedded Signup config ID

    // Called once SDK is loaded
    function initFB() {
      logStatus('Initializing FB SDK…');
      FB.init({
        appId            : APP_ID,
        autoLogAppEvents : true,
        xfbml            : false,
        version          : 'v23.0'
      });
      logStatus('FB SDK initialized. Launching Embedded Signup...');
      launchWhatsAppSignup();
    }

    // Listen for the signup result via postMessage
    window.addEventListener('message', event => {
      // Only accept messages from Facebook
      console.log(event, 'this is event')
      // if (!['https://www.facebook.com', 'https://web.facebook.com'].includes(event.origin)) {
      //  return;
      //} 
      let data;
      try { data = JSON.parse(event.data);
        console.log("outside ", data);
        if (data.type === 'WA_EMBEDDED_SIGNUP') {
        //logStatus('Signup completed. Sending to React Native…');
        console.log("inside " , data);
       // postToRN({ success: true, data });
        
      }
       }
      catch { return; }
      // The Embedded Signup payload has type 'WA_EMBEDDED_SIGNUP'

    });

    // Launch the Embedded Signup flow automatically
    function launchWhatsAppSignup() {
      FB.login(response => {
        if (response.status === 'connected') {
          logStatus('Login succeeded, awaiting embedded signup…');
        } else {
          logStatus('User canceled or login failed');
          postToRN({ success: false, error: response });
        }
      }, {
        config_id: CONFIG_ID,
        response_type: 'code',
        override_default_response_type: true,
        extras: {
          setup: {},
          featureType: '',
          sessionInfoVersion: '3'
        }
      });
    }
  </script>
</head>

<body>
  <h2>WhatsApp Embedded Signup</h2>
  <div id="status">Initializing…</div>
</body>
</html>
